<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio IA - Tu Director de Arte IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root { --bg-primary: #111827; --bg-secondary: #1F2937; --border-color: #374151; --text-primary: #F9FAFB; --text-secondary: #9CA3AF; --accent-primary: #2563EB; --accent-glow: rgba(37, 99, 235, 0.5); }
        html.dark { color-scheme: dark; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
        h1, h2, h3, .font-heading { font-family: 'Plus Jakarta Sans', sans-serif; }
        .btn-primary { background-color: var(--accent-primary); transition: all 0.3s ease; box-shadow: 0 0 15px rgba(37, 99, 235, 0); }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent-glow); }
        .btn-primary:disabled { background: #374151; cursor: not-allowed; }
        .loader { width: 48px; height: 48px; border: 3px solid var(--text-primary); border-radius: 50%; display: inline-block; position: relative; box-sizing: border-box; animation: rotation 1s linear infinite; }
        .loader::after { content: ''; box-sizing: border-box; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; border-radius: 50%; border: 3px solid; border-color: var(--accent-primary) transparent; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in-up { animation: fadeInUp 0.6s ease-in-out forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .upload-box { border: 2px dashed var(--border-color); background-color: rgba(31, 41, 55, 0.5); transition: all 0.3s ease; }
        .upload-box:hover { border-color: var(--accent-primary); background-color: var(--bg-secondary); }
        .mode-btn.active { background-color: var(--accent-primary); color: var(--text-primary); }
        .image-card:hover .image-overlay { opacity: 1; }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-black bg-opacity-30 backdrop-blur-lg p-4 flex justify-between items-center sticky top-0 z-20 border-b border-gray-800">
        <div class="flex items-center space-x-3">
            <h1 class="text-2xl font-bold text-white font-heading">Studio IA</h1>
            <span class="hidden md:inline-block bg-gray-700 text-blue-400 text-xs font-semibold px-2 py-1 rounded-full">PRO</span>
        </div>
    </header>
    <main class="grid grid-cols-1 lg:grid-cols-12 gap-6 p-6">
        <div class="lg:col-span-4 xl:col-span-3 bg-secondary rounded-xl border border-border-color p-6 space-y-6 self-start fade-in-up">
            <div class="bg-primary rounded-lg p-1 flex">
                <button id="mode-single" class="mode-btn w-1/2 p-2 rounded-md text-sm font-semibold active">Producto Individual</button>
                <button id="mode-collection" class="mode-btn w-1/2 p-2 rounded-md text-sm font-semibold">Book de Colección</button>
            </div>
            <div id="single-product-panel" class="space-y-6">
                <div>
                    <h2 class="text-lg font-bold mb-2 font-heading">1. Prenda Principal</h2>
                    <div id="uploader-main" class="upload-box p-4 rounded-lg"><input type="file" class="hidden image-input" data-uploader="main"><div class="upload-prompt flex flex-col items-center justify-center text-gray-400"><i class="fas fa-tshirt text-4xl mb-2"></i><p class="font-semibold text-sm">Arrastra o haz clic para subir</p></div><div class="image-preview-container hidden relative"><img src="#" alt="Vista previa" class="image-preview w-full h-auto rounded-md"/><button class="remove-image-btn absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold">&times;</button></div></div>
                </div>
                <div class="space-y-4">
                    <h2 class="text-lg font-bold font-heading">2. Dirección de Arte IA</h2>
                    <div>
                        <label for="photo-style" class="block text-sm font-medium text-gray-400 mb-1">Estilo Profesional (10 Opciones)</label>
                        <select id="photo-style" class="w-full p-2 bg-primary border border-border-color rounded-md shadow-sm focus:ring-accent-primary focus:border-accent-primary">
                            <option value="fitness">Fitness / Gimnasio</option>
                            <option value="beachwear">Traje de Baño / Playa</option>
                            <option value="winter_fashion">Moda de Invierno</option>
                            <option value="urban_lookbook">Lookbook Urbano</option>
                            <option value="scandi_minimalist">Minimalista Escandinavo</option>
                            <option value="luxury_fashion">Lujo / Alta Costura</option>
                            <option value="boho_lifestyle">Bohemio / Estilo de Vida</option>
                            <option value="corporate_business">Corporativo / Negocios</option>
                            <option value="kids_playful">Ropa Infantil / Juguetona</option>
                            <option value="studio_product">Producto en Estudio (Bodegón)</option>
                        </select>
                    </div>
                     <div>
                        <label for="model-desc" class="block text-sm font-medium text-gray-400 mb-1">Descripción del Modelo</label>
                        <input type="text" id="model-desc" class="w-full p-2 bg-primary border border-border-color rounded-md" placeholder="Ej: Mujer latina, pelo castaño, 25 años">
                    </div>
                </div>
            </div>
             <div id="collection-photoshoot-panel" class="hidden space-y-6">
                 <div>
                    <h2 class="text-lg font-bold mb-1 font-heading">1. Colección de Prendas</h2>
                    <div id="uploader-collection" class="upload-box p-4 rounded-lg"><input type="file" id="collection-input" class="hidden" multiple accept="image/*"><div class="upload-prompt flex flex-col items-center justify-center text-gray-400"><i class="fas fa-images text-4xl mb-2"></i><p class="font-semibold text-sm">Subir hasta 10 prendas</p></div></div>
                    <div id="collection-previews" class="grid grid-cols-4 gap-2 mt-2"></div>
                </div>
                 <div>
                    <h2 class="text-lg font-bold mb-2 font-heading">2. Briefing del Photoshoot</h2>
                     <select id="collection-photo-style" class="w-full p-2 bg-primary border border-border-color rounded-md shadow-sm focus:ring-accent-primary focus:border-accent-primary mb-2">
                        <option value="fitness">Estilo: Fitness / Gimnasio</option>
                        <option value="beachwear">Estilo: Traje de Baño / Playa</option>
                        <option value="winter_fashion">Estilo: Moda de Invierno</option>
                        <option value="urban_lookbook">Estilo: Lookbook Urbano</option>
                        <option value="scandi_minimalist">Estilo: Minimalista Escandinavo</option>
                        <option value="luxury_fashion">Estilo: Lujo / Alta Costura</option>
                        <option value="boho_lifestyle">Estilo: Bohemio / Estilo de Vida</option>
                        <option value="corporate_business">Estilo: Corporativo / Negocios</option>
                        <option value="kids_playful">Estilo: Ropa Infantil / Juguetona</option>
                    </select>
                    <textarea id="collection-prompt" rows="4" class="w-full p-2 bg-primary border border-border-color rounded-md" placeholder="Ej: Tres modelos diferentes (2 mujeres, 1 hombre) interactuando."></textarea>
                </div>
                <div>
                    <label for="collection-results-count" class="block text-sm font-medium text-gray-400 mb-1">Número de Resultados (1-10)</label>
                    <input type="number" id="collection-results-count" value="4" min="1" max="10" class="w-full p-2 bg-primary border border-border-color rounded-md">
                </div>
            </div>
            <button id="generate-btn" class="w-full py-3 px-4 text-white font-bold text-base rounded-lg shadow-lg btn-primary flex items-center justify-center space-x-2" disabled><i class="fas fa-magic"></i><span id="generate-btn-text">Generar</span></button>
             <p id="progress-text" class="text-center text-sm text-gray-400 h-4"></p>
        </div>
        <div class="lg:col-span-8 xl:col-span-9 p-6">
            <h2 class="text-2xl font-bold mb-4 font-heading">Resultados</h2>
            <div id="results-gallery" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 min-h-[600px]">
                <div id="gallery-placeholder" class="col-span-full flex flex-col items-center justify-center text-center text-gray-500 h-full fade-in-up"><h3 class="text-xl font-semibold font-heading text-gray-300">Tu lienzo creativo espera</h3><p class="text-gray-500 max-w-sm">Configura tu sesión de fotos a la izquierda y observa cómo la IA da vida a tus prendas.</p></div>
                <div id="gallery-loader" class="hidden col-span-full flex flex-col items-center justify-center text-center text-gray-500 h-full"><span class="loader"></span><h3 class="text-lg font-semibold mt-4 text-gray-400">Creando magia...</h3></div>
            </div>
        </div>
    </main>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- UI Elements ---
            const generateBtn = document.getElementById('generate-btn');
            const generateBtnText = document.getElementById('generate-btn-text');
            const progressText = document.getElementById('progress-text');
            const resultsGallery = document.getElementById('results-gallery');
            const galleryPlaceholder = document.getElementById('gallery-placeholder');
            const galleryLoader = document.getElementById('gallery-loader');
            const modeSingleBtn = document.getElementById('mode-single');
            const modeCollectionBtn = document.getElementById('mode-collection');
            const singleProductPanel = document.getElementById('single-product-panel');
            const collectionPhotoshootPanel = document.getElementById('collection-photoshoot-panel');
            const collectionUploader = document.getElementById('uploader-collection');
            const collectionInput = document.getElementById('collection-input');
            const collectionPreviews = document.getElementById('collection-previews');
            
            // --- State ---
            let currentMode = 'single';
            let uploadedImages = { main: null };
            let collectionImages = [];

            // --- Uploader Initialization ---
            function initializeUploader(uploaderId) {
                const uploaderEl = document.getElementById(uploaderId);
                const inputEl = uploaderEl.querySelector('.image-input');
                const promptEl = uploaderEl.querySelector('.upload-prompt');
                const previewContainerEl = uploaderEl.querySelector('.image-preview-container');
                const previewEl = uploaderEl.querySelector('.image-preview');
                const removeBtn = uploaderEl.querySelector('.remove-image-btn');
                const uploaderKey = inputEl.dataset.uploader;
                uploaderEl.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('remove-image-btn')) { inputEl.click(); }
                });
                inputEl.addEventListener('change', e => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = re => {
                            uploadedImages[uploaderKey] = re.target.result.split(',')[1];
                            previewEl.src = re.target.result;
                            promptEl.classList.add('hidden');
                            previewContainerEl.classList.remove('hidden');
                            checkGenerateButtonState();
                        };
                        reader.readAsDataURL(file);
                    }
                });
                removeBtn.addEventListener('click', e => {
                    e.stopPropagation();
                    inputEl.value = '';
                    uploadedImages[uploaderKey] = null;
                    promptEl.classList.remove('hidden');
                    previewContainerEl.classList.add('hidden');
                    checkGenerateButtonState();
                });
            }
            ['uploader-main'].forEach(initializeUploader);

            collectionUploader.addEventListener('click', () => collectionInput.click());
            collectionInput.addEventListener('change', e => {
                const files = Array.from(e.target.files);
                if (collectionImages.length + files.length > 10) { alert("Puedes subir un máximo de 10 prendas."); return; }
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = re => {
                        const base64 = re.target.result.split(',')[1];
                        collectionImages.push({ name: file.name, base64 });
                        renderCollectionPreviews();
                        checkGenerateButtonState();
                    };
                    reader.readAsDataURL(file);
                });
                collectionInput.value = '';
            });

            function renderCollectionPreviews() {
                collectionPreviews.innerHTML = '';
                collectionImages.forEach((img, index) => {
                    const div = document.createElement('div');
                    div.className = 'relative aspect-square';
                    div.innerHTML = `<img src="data:image/png;base64,${img.base64}" class="w-full h-full object-cover rounded-md"><button data-index="${index}" class="remove-collection-item absolute top-1 right-1 bg-red-600 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold">&times;</button>`;
                    collectionPreviews.appendChild(div);
                });
                collectionUploader.querySelector('.upload-prompt').classList.toggle('hidden', collectionImages.length > 0);
            }
            
            collectionPreviews.addEventListener('click', e => {
                if(e.target.classList.contains('remove-collection-item')) {
                    collectionImages.splice(parseInt(e.target.dataset.index, 10), 1);
                    renderCollectionPreviews();
                    checkGenerateButtonState();
                }
            });

            // --- Mode Switching ---
            function switchMode(mode) {
                currentMode = mode;
                modeSingleBtn.classList.toggle('active', mode === 'single');
                modeCollectionBtn.classList.toggle('active', mode === 'collection');
                singleProductPanel.classList.toggle('hidden', mode !== 'single');
                collectionPhotoshootPanel.classList.toggle('hidden', mode !== 'collection');
                checkGenerateButtonState();
            }
            modeSingleBtn.addEventListener('click', () => switchMode('single'));
            modeCollectionBtn.addEventListener('click', () => switchMode('collection'));

            function checkGenerateButtonState() {
                generateBtn.disabled = (currentMode === 'single') ? !uploadedImages.main : collectionImages.length === 0;
            }

            // --- Main Generation Logic ---
            generateBtn.addEventListener('click', () => {
                resultsGallery.innerHTML = '';
                galleryPlaceholder.classList.add('hidden');
                galleryLoader.classList.remove('hidden');
                setLoadingState(true, 0, 0);
                if (currentMode === 'single') handleSingleGeneration();
                else handleCollectionGeneration();
            });

            async function handleSingleGeneration() {
                const prompt = constructPrompt();
                const images = Object.values(uploadedImages).filter(Boolean);
                try {
                    const generatedImage = await callNanoBananaAPI(prompt, images);
                    if (generatedImage) addImageToGallery(generatedImage);
                } catch (error) { console.error('Error:', error); }
                finally { setLoadingState(false, 1, 1); }
            }

            async function handleCollectionGeneration() {
                const count = parseInt(document.getElementById('collection-results-count').value, 10);
                for (let i = 0; i < count; i++) {
                    setLoadingState(true, i, count);
                    try {
                        const garmentsForShot = [...collectionImages].sort(() => 0.5 - Math.random()).slice(0, Math.min(Math.floor(Math.random() * 3) + 1, collectionImages.length));
                        const prompt = constructPrompt(garmentsForShot);
                        const images = garmentsForShot.map(g => g.base64);
                        const generatedImage = await callNanoBananaAPI(prompt, images);
                        if (generatedImage) addImageToGallery(generatedImage, i);
                    } catch (error) { console.error(`Error en la generación ${i + 1}:`, error); }
                }
                setLoadingState(false, count, count);
            }

            // --- Prompt Engineering Engine ---
            function getProfessionalPromptBooster(style, modelDesc) {
                const negativePrompt = "AVOID the following: 3d render, cgi, cartoon, illustration, blurry, deformed, bad anatomy, ugly, disfigured, low quality, unrealistic, overprocessed skin, plastic look, artifacts.";
                let masterPrompt = "";
                switch (style) {
                    case 'fitness': masterPrompt = `Editorial fitness photoshoot inside a modern, gritty gym with high-contrast cinematic lighting. A ${modelDesc} is performing a dynamic, powerful pose, highlighting the clothing's performance. Shot on a Sony A7R IV, 85mm f/1.4 lens, hyperrealistic, sharp focus, professional color grading.`; break;
                    case 'beachwear': masterPrompt = `Luxury swimwear campaign photoshoot on a pristine beach at golden hour. A ${modelDesc} poses elegantly near the turquoise water. Soft, warm light. Shot on a Canon EOS R5, 70-200mm f/2.8 lens, photorealistic, high detail, natural skin texture.`; break;
                    case 'winter_fashion': masterPrompt = `High-fashion winter clothing photoshoot in a snowy aspen forest. A ${modelDesc} is dressed warmly, looking chic. Crisp, cool lighting. Shot on a Fujifilm GFX 100, medium format look, incredibly detailed textures.`; break;
                    case 'urban_lookbook': masterPrompt = `Street style lookbook photoshoot in Tokyo. A ${modelDesc} has a confident, natural pose against an interesting urban background. Shot on a Leica M11, 35mm f/1.4 lens, candid style, cinematic, film grain, hyperrealistic.`; break;
                    case 'scandi_minimalist': masterPrompt = `Scandinavian minimalist lookbook. A ${modelDesc} in a calm pose within a minimalist studio. Soft, diffused natural light. Shot on a Fujifilm GFX 100S, exquisite detail in fabric textures. Clean, serene. Hyperrealistic.`; break;
                    case 'luxury_fashion': masterPrompt = `High-fashion editorial. A ${modelDesc} in an avant-garde pose in a grand architectural space. Dramatic, high-contrast lighting. Shot on a Phase One XF camera, sharp, high-end look. Hyperrealistic.`; break;
                    case 'boho_lifestyle': masterPrompt = `Candid bohemian-chic photoshoot. A ${modelDesc} is laughing in a sun-drenched field at golden hour. Warm, hazy light, artistic lens flare. Shot on a Canon EOS 5D Mark IV, 50mm f/1.2, dreamy depth of field. Photorealistic.`; break;
                    case 'corporate_business': masterPrompt = `Professional corporate lookbook. A ${modelDesc} with a confident expression in a modern office, blurred city view. Clean, soft lighting. Shot on a Nikon Z8, 24-70mm f/2.8, polished. Hyperrealistic.`; break;
                    case 'kids_playful': masterPrompt = `Vibrant children's clothing catalog. A ${modelDesc} (described as a child) is captured mid-laugh in a colorful setting. High-key lighting, cheerful. Shot on a Sony A1, 50mm f/1.8 to freeze motion. Hyperrealistic.`; break;
                    case 'studio_product': masterPrompt = `Professional e-commerce photoshoot of the garment on an invisible mannequin (ghost mannequin effect), in a studio with perfect, even lighting against a solid light gray background (#f2f2f2). Shot on a Phase One camera, macro lens for extreme detail on the fabric.`; break;
                }
                return `${masterPrompt} ${negativePrompt}`;
            }
            
            function constructPrompt(collectionItems = null) {
                if (currentMode === 'single') {
                    const style = document.getElementById('photo-style').value;
                    const modelDesc = document.getElementById('model-desc').value || 'professional model';
                    let finalPrompt = getProfessionalPromptBooster(style, modelDesc);
                    if (uploadedImages.main && style !== 'studio_product') finalPrompt += ' The model is wearing the main provided garment.';
                    return finalPrompt;
                } else {
                    const style = document.getElementById('collection-photo-style').value;
                    const baseDesc = document.getElementById('collection-prompt').value || 'A group of models';
                    let finalPrompt = getProfessionalPromptBooster(style, baseDesc);
                    const garmentNames = collectionItems.map(g => `'${g.name}'`).join(', ');
                    finalPrompt += ` The models are showcasing a collection of garments including: ${garmentNames}. Create a cohesive campaign image.`;
                    return finalPrompt;
                }
            }
            
            // --- API Call to Google AI Studio ---
            async function callNanoBananaAPI(prompt, base64ImagesArray) {
                const apiKey = ""; // API Key is handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                
                const parts = [{ text: prompt }];
                base64ImagesArray.forEach(imgData => parts.push({ inlineData: { mimeType: "image/png", data: imgData } }));
                
                const payload = {
                    contents: [{ parts }],
                    generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                };
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }
                
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
                if (!base64Data) {
                    if (result.candidates && result.candidates[0] && result.candidates[0].finishReason === 'SAFETY') {
                        throw new Error("Imagen bloqueada por políticas de seguridad de la IA.");
                    }
                    throw new Error("No se recibió una imagen válida de la API.");
                }
                return `data:image/png;base64,${base64Data}`;
            }

            // --- UI Helper Functions ---
            function setLoadingState(isLoading, current, total) {
                generateBtn.disabled = isLoading;
                galleryLoader.classList.toggle('hidden', !isLoading);
                generateBtnText.textContent = isLoading ? "Generando..." : "Generar";
                progressText.textContent = (isLoading && total > 1) ? `Generando ${current + 1} de ${total}...` : '';
                if (!isLoading && !resultsGallery.hasChildNodes()) galleryPlaceholder.classList.remove('hidden');
            }
            
            function addImageToGallery(imageUrl, delay = 0) {
                const card = document.createElement('div');
                card.className = 'image-card group relative aspect-[4/5] rounded-lg shadow-lg overflow-hidden fade-in-up';
                card.style.animationDelay = `${delay * 100}ms`;
                card.innerHTML = `<img src="${imageUrl}" alt="Generated image" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"><div class="image-overlay absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex flex-col justify-end p-4"><a href="${imageUrl}" download="StudioIA_Result_${Date.now()}.png" class="w-full bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-md hover:bg-blue-700 transition flex items-center justify-center space-x-1.5 translate-y-4 group-hover:translate-y-0 duration-300"><i class="fas fa-download"></i><span>Descargar</span></a></div>`;
                resultsGallery.prepend(card);
            }

            checkGenerateButtonState();
        });
    </script>
</body>
</html>

